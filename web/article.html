<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Article - NewsBalancer</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script>
        // Error handling utility for standardized error management
        const errorHandler = {
            // Parse error from response
            parseError: async function(response) {
                try {
                    const data = await response.json();
                    if (data && data.error && data.error.message) {
                        return data.error.message;
                    }
                    return `HTTP error ${response.status}: ${response.statusText}`;
                } catch (e) {
                    // Log the error but return a user-friendly message
                    console.error("Error parsing error response:", e);
                    return `HTTP error ${response.status}: ${response.statusText}`;
                }
            },
            
            // Display error in a specific element
            showError: function(element, message) {
                if (!element) return;
                element.textContent = message;
                element.style.display = 'block';
                console.error(message);
            },
            
            // Show a timed success message
            showSuccess: function(element, message, timeout = 3000) {
                if (!element) return;
                const originalColor = element.style.color || '';
                element.textContent = message;
                element.style.color = 'green';
                element.style.display = 'block';
                
                setTimeout(() => {
                    element.style.display = 'none';
                    element.style.color = originalColor;
                }, timeout);
            },
            
            // Show an alert with error (fallback)
            alertError: function(message) {
                console.error(message);
                alert(`Error: ${message}`);
            }
        };
    </script>
    <style>
        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f9f9f9;
            --primary-text: #222222;
            --secondary-text: #555555;
            --highlight-bg: #eef2ff;
            --border-color: #ccc;
            --accent-color: #3366cc;
            --hover-bg: #f0f0f0;
            --confidence-high: #4caf50;
            --confidence-medium: #ff9800;
            --confidence-low: #f44336;
            --left-color: #2196f3;
            --right-color: #f44336;
            --center-color: #9e9e9e;
        }

        /* Tooltip styling */
        [data-tooltip] {
            position: relative;
            cursor: pointer;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            white-space: pre-line;
            position: absolute;
            left: 50%;
            top: 120%;
            transform: translateX(-50%);
            background: #222;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.95em;
            z-index: 10;
            min-width: 180px;
            max-width: 320px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            pointer-events: none;
        }
        
        /* Confidence indicator dot */
        .confidence-indicator {
            display: inline-block;
            width: 0.85em;
            height: 0.85em;
            border-radius: 50%;
            margin-right: 0.4em;
            vertical-align: middle;
        }

        body {
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--primary-text);
            background-color: var(--primary-bg);
            margin: 0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        header, main {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        header h1 {
            font-family: Georgia, serif;
            font-size: 2rem;
            margin: 0;
        }

        .article-container {
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .article-header {
            margin-bottom: 2rem;
        }

        .article-header h1 {
            font-family: Georgia, serif;
            font-size: 2.2rem;
            margin: 0 0 0.5rem 0;
            line-height: 1.2;
        }

        .article-metadata {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            color: var(--secondary-text);
            font-size: 0.9rem;
        }

        .article-content {
            margin: 1.5rem 0;
            line-height: 1.7;
            font-size: 1.1rem;
        }

        .article-content p {
            margin-bottom: 1.2rem;
        }

        .metadata {
            font-size: 0.9rem;
            color: var(--secondary-text);
            background: var(--highlight-bg);
            padding: 0.75rem;
            border-radius: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .bias-slider-container {
            margin: 1.5rem 0;
        }

        .bias-slider {
            width: 100%;
            height: 12px;
            background: linear-gradient(to right, var(--left-color), var(--center-color), var(--right-color));
            border-radius: 6px;
            position: relative;
            margin: 0.5rem 0;
        }

        .bias-indicator {
            width: 12px;
            height: 24px;
            border-radius: 6px;
            position: absolute;
            top: -6px;
            transform: translateX(-50%);
            background: #000;
            z-index: 2;
        }

        .composite-indicator {
            border: 2px solid #fff;
            width: 14px;
            height: 28px;
            border-radius: 7px;
            z-index: 3;
        }

        .model-indicator {
            width: 8px;
            height: 18px;
            background: rgba(0,0,0,0.6);
            z-index: 1;
        }

        .explanation {
            background: var(--secondary-bg);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .explanation p {
            margin: 0;
            font-style: italic;
        }

        .advanced-section {
            display: none;
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 6px;
            margin-top: 1rem;
        }

        .advanced-section.visible {
            display: block;
        }

        button {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        button:hover {
            background: var(--hover-bg);
        }

        .primary-button {
            background: var(--accent-color);
            color: white;
            border: none;
            text-decoration: none;
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }

        .primary-button:hover {
            opacity: 0.9;
        }

        .score-article-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 6px;
        }

        .score-article-section label {
            display: block;
            margin-bottom: 0.5rem;
        }

        .score-article-section input {
            padding: 0.5rem;
            margin-right: 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .score-progress-bar-bg {
            width: 100%;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .score-progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent-color);
            transition: width 0.3s;
        }

        .score-progress-messages {
            margin-top: 0.5rem;
            padding-left: 1.5rem;
        }

        .llm-rescore-spinner {
            display: inline-block;
            margin-left: 0.5rem;
        }

        .ensemble-list {
            padding-left: 1.5rem;
        }

        .ensemble-list li {
            margin-bottom: 0.5rem;
        }

        .feedback-section {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .feedback-form {
            margin-top: 1rem;
            background: var(--secondary-bg);
            padding: 1rem;
            border-radius: 6px;
        }

        .feedback-form textarea {
            width: 100%;
            min-height: 100px;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .feedback-form fieldset {
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .feedback-form fieldset div {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .success-message {
            color: green;
            background: #e8f5e9;
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .error-message {
            color: var(--confidence-low);
            background: #ffebee;
            padding: 0.75rem;
            border-radius: 6px;
        }

        @media (max-width: 768px) {
            .article-container {
                padding: 1rem;
            }
            
            .article-header h1 {
                font-size: 1.8rem;
            }
            
            .metadata {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1><a href="/" style="text-decoration: none; color: inherit;">NewsBalancer</a></h1>
        <a href="/" class="primary-button">Back to Articles</a>
    </header>

    <main id="article-detail">
        <div class="article-container">
            <div class="article-header">
                <h1 id="article-title">{{.Title}}</h1>
                <div class="article-metadata">
                    <span><strong>Source:</strong> {{.Source}}</span>
                    <span><strong>Published:</strong> {{.PubDate}}</span>
                    <span><strong>Fetched:</strong> {{.CreatedAt}}</span>
                </div>
            </div>

            <div class="metadata">
                <span><strong>ID:</strong> {{.ID}}</span>
                <span><strong>Source:</strong> {{.Source}}</span>
                <span><strong>Published:</strong> {{.PubDate}}</span>
                <span><strong>Fetched:</strong> {{.CreatedAt}}</span>
                <span class="bias-label" aria-label="Composite Bias">Composite: {{.BiasLabel}}</span>
                <span class="confidence" aria-label="Composite Confidence">
                    <span class="confidence-indicator" style="background:{{.ConfidenceColor}}"></span>
                    Confidence: {{.ConfidencePercent}}%
                </span>
                <span class="composite-score" aria-label="Composite Score">
                    Score: {{.CompositeScore}}
                </span>
            </div>
            <div class="bias-slider-container">
                <div class="bias-slider">
                    <div class="bias-indicator composite-indicator" style="left:{{.SliderPosition}}%" title="Composite Score: {{.CompositeScore}}"></div>
                    {{range .ModelIndicators}}
                    <div class="bias-indicator model-indicator" style="left:{{.Position}}%" title="{{.Title}}"></div>
                    {{end}}
                </div>
            </div>
            <section class="explanation">
                <p id="bias-explanation">{{.Explanation}}</p>
            </section>
            <div class="article-content">
                <p>{{.Content}}</p>
            </div>
            <div class="score-article-section">
                <label for="manual-score-input">Manual Score:</label>
                <input type="number" id="manual-score-input" name="manual-score-input" min="-1" max="1" step="0.01" placeholder="Enter score (-1 to 1)" />
                <button type="button" class="manual-score-btn" onclick="manualScoreArticle('{{.ID}}')">Submit Manual Score</button>
                <div class="manual-score-error-message" style="color:red;display:none;margin-top:0.5em;"></div>
                <button type="button" class="llm-rescore-btn" onclick="llmRescoreArticle('{{.ID}}')">
                    LLM Rescore Article
                    <span class="llm-rescore-spinner" style="display:none;">⏳</span>
                </button>
                <div class="llm-rescore-progress-container" style="display:none;">
                    <div class="score-progress-bar-bg">
                        <div class="score-progress-bar"></div>
                    </div>
                    <ul class="score-progress-messages"></ul>
                </div>
                <div class="llm-rescore-error-message" style="color:red;display:none;margin-top:0.5em;"></div>
            </div>
            <button type="button" onclick="toggleAdvanced(this)">Toggle Advanced View</button>
            <section class="advanced-section">
                <p><strong>Ensemble Details:</strong></p>
                <div id="ensemble-details">
                    <p>Loading ensemble details...</p>
                </div>
            </section>
            <div class="feedback-section">
                <button type="button" onclick="showFeedbackForm('{{.ID}}')">Give Feedback</button>
                <div id="feedback-form" class="feedback-form" style="display:none;">
                    <form onsubmit="submitFeedback(event, '{{.ID}}')">
                        <label for="feedback-text">Your feedback:</label>
                        <textarea id="feedback-text" name="feedback_text" rows="3" required></textarea>
                        <fieldset>
                            <legend>Category:</legend>
                            <div>
                                <label><input type="radio" name="category" value="agree" required> Agree</label>
                                <label><input type="radio" name="category" value="too_left"> Too Left</label>
                                <label><input type="radio" name="category" value="too_right"> Too Right</label>
                                <label><input type="radio" name="category" value="parse_error"> Parse Error</label>
                                <label><input type="radio" name="category" value="model_disagreement"> Model Disagreement</label>
                            </div>
                        </fieldset>
                        <button type="submit">Submit Feedback</button>
                        <button type="button" onclick="hideFeedbackForm()">Cancel</button>
                    </form>
                </div>
                <div id="feedback-success" class="success-message" style="display:none;">Thank you for your feedback!</div>
            </div>
        </div>
    </main>

    <script>
        // Helper functions for score display
        function getScoreLabel(score) {
            if (score === null || score === undefined) return 'Not scored';
            if (score < -0.5) return 'Left';
            if (score < -0.1) return 'Slightly Left';
            if (score > 0.5) return 'Right';
            if (score > 0.1) return 'Slightly Right';
            return 'Center';
        }

        function getConfidenceColor(confidence) {
            if (confidence >= 0.8) return 'var(--confidence-high)';
            if (confidence >= 0.5) return 'var(--confidence-medium)';
            return 'var(--confidence-low)';
        }

        // Helper functions for ensemble details
        function createModelIndicator(result) {
            if (result.score === undefined) return '';
            
            const modelName = result.model || 'Unknown Model';
            const score = result.score.toFixed(2);
            const confidence = result.confidence !== undefined ? 
                `${(result.confidence * 100).toFixed(0)}%` : 'N/A';
            
            let listItem = `
                <li>
                    <strong>${modelName}</strong>: 
                    Score: ${score}, 
                    Confidence: ${confidence}
            `;
            
            if (result.explanation) {
                listItem += `<br><em>Explanation: ${result.explanation}</em>`;
            }
            
            listItem += '</li>';
            return listItem;
        }

        function createAggregationStats(aggregation) {
            if (!aggregation || Object.keys(aggregation).length === 0) return '';
            
            const mean = aggregation.weighted_mean !== undefined ? 
                aggregation.weighted_mean.toFixed(2) : 'N/A';
            const variance = aggregation.variance !== undefined ? 
                aggregation.variance.toFixed(2) : 'N/A';
            
            return `
                <p><strong>Aggregation Stats:</strong> 
                Weighted Mean: ${mean}, 
                Variance: ${variance}
                </p>
            `;
        }

        function updateBiasSlider(slider, subResults) {
            if (!slider) return;
            
            // Remove existing indicators
            slider.querySelectorAll('.model-indicator').forEach(el => el.remove());
            
            // Add new indicators
            subResults.forEach(result => {
                if (result.score !== undefined) {
                    const indicator = document.createElement('div');
                    indicator.className = 'bias-indicator model-indicator';
                    indicator.setAttribute('data-model-position', `${((result.score + 1) / 2) * 100}`);
                    indicator.title = `${result.model || 'Model'}: ${result.score.toFixed(2)}`;
                    slider.appendChild(indicator);
                }
            });
        }

        // Load ensemble details for the article
        async function loadEnsembleDetails(articleId, cacheBuster = '') {
            const ensembleContainer = document.getElementById('ensemble-details');
            const explanationElement = document.getElementById('bias-explanation');
            
            if (!ensembleContainer) return;
            
            try {
                const timestamp = cacheBuster || '';
                const response = await fetch(`/api/articles/${articleId}/ensemble${timestamp ? `?_t=${timestamp}` : ''}`);
                
                if (response.status === 404) {
                    const message = '<p>No ensemble data available for this article.</p>';
                    ensembleContainer.innerHTML = message;
                    if (explanationElement) {
                        explanationElement.textContent = 'No scoring data available for this article.';
                    }
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch ensemble data: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success || !data.scores?.[0]) {
                    ensembleContainer.innerHTML = '<p>No ensemble data available for this article.</p>';
                    return;
                }
                
                const latestEnsemble = data.scores[0];
                const subResults = latestEnsemble.sub_results || [];
                
                // Generate ensemble details HTML
                let ensemblesHtml = '<ul class="ensemble-list">';
                ensemblesHtml += subResults.map(createModelIndicator).join('');
                ensemblesHtml += '</ul>';
                ensemblesHtml += createAggregationStats(latestEnsemble.aggregation);
                
                ensembleContainer.innerHTML = ensemblesHtml;
                
                // Update explanation if available
                if (explanationElement && subResults[0]?.explanation) {
                    explanationElement.textContent = subResults[0].explanation;
                }
                
                // Update bias slider
                updateBiasSlider(document.querySelector('.bias-slider'), subResults);
                
            } catch (error) {
                console.error('Error loading ensemble details:', error);
                ensembleContainer.innerHTML = `<p class="error-message">Failed to load ensemble details: ${error.message}</p>`;
            }
        }

        // Helper functions for article details updates
        function updateConfidenceDisplay(metadataSection, confidence) {
            const confidenceElement = metadataSection.querySelector('.confidence');
            if (confidenceElement) {
                let content = '';
                if (confidence !== null) {
                    const color = getConfidenceColor(confidence);
                    const percent = Math.round(confidence * 100);
                    content = `<span class="confidence-indicator" style="background:${color};"></span>Confidence: ${percent}%`;
                } else {
                    content = 'Confidence: --';
                }
                confidenceElement.innerHTML = content;
            }
        }

        function updateScoreDisplay(metadataSection, compositeScore) {
            const compositeScoreElement = metadataSection.querySelector('.composite-score');
            const biasLabelElement = metadataSection.querySelector('.bias-label');
            
            if (compositeScoreElement) {
                compositeScoreElement.textContent = compositeScore !== null ? 
                    `Score: ${compositeScore.toFixed(2)}` : 'Score: --';
            }
            if (biasLabelElement) {
                biasLabelElement.textContent = `Composite: ${getScoreLabel(compositeScore)}`;
            }
        }

        function updateSliderPosition(compositeScore) {
            const biasSlider = document.querySelector('.bias-slider');
            const compositeIndicator = biasSlider?.querySelector('.composite-indicator');
            
            if (compositeIndicator && compositeScore !== null) {
                compositeIndicator.setAttribute('data-slider-position', 
                    `${((compositeScore + 1) / 2) * 100}`);
            }
        }

        async function updateArticleDetails(articleId, cacheBuster = '') {
            try {
                const timestamp = cacheBuster || '';
                const response = await fetch(`/api/articles/${articleId}${timestamp ? `?_t=${timestamp}` : ''}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch article details: ${response.statusText}`);
                }

                const responseData = await response.json();
                if (!responseData.success || !responseData.data) {
                    throw new Error('Invalid article data received');
                }

                const article = responseData.data;
                // Handle both snake_case and PascalCase field names
                const compositeScore = article.composite_score !== undefined ? article.composite_score : 
                                       (article.CompositeScore !== undefined ? article.CompositeScore : null);
                const confidence = article.confidence !== undefined ? article.confidence : 
                                  (article.Confidence !== undefined ? article.Confidence : null);
                
                const metadataSection = document.querySelector('.metadata');
                if (metadataSection) {
                    updateConfidenceDisplay(metadataSection, confidence);
                    updateScoreDisplay(metadataSection, compositeScore);
                    updateSliderPosition(compositeScore);
                }
            } catch (error) {
                console.error('Error updating article details:', error);
            }
        }
        
        // Show feedback form
        function showFeedbackForm(articleId) {
            const formContainer = document.getElementById('feedback-form');
            const button = document.querySelector('.feedback-section button');
            if (formContainer) {
                formContainer.style.display = 'block';
                button.style.display = 'none';
            }
        }
        
        // Hide feedback form
        function hideFeedbackForm() {
            const formContainer = document.getElementById('feedback-form');
            const button = document.querySelector('.feedback-section button');
            if (formContainer) {
                formContainer.style.display = 'none';
                button.style.display = 'inline-block';
            }
        }
        
        // Submit feedback
        async function submitFeedback(event, articleId) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const feedbackText = formData.get('feedback_text');
            const category = formData.get('category');
            
            if (!feedbackText || !category) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        article_id: parseInt(articleId),
                        user_id: 'web-user',
                        feedback_text: feedbackText,
                        category: category,
                        source: 'web'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Failed to submit feedback');
                }
                
                // Show success message
                const formContainer = document.getElementById('feedback-form');
                const successMessage = document.getElementById('feedback-success');
                
                if (formContainer && successMessage) {
                    formContainer.style.display = 'none';
                    successMessage.style.display = 'block';
                    
                    // Hide success message after 3 seconds
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                        const button = document.querySelector('.feedback-section button');
                        button.style.display = 'inline-block';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error submitting feedback:', error);
                alert(`Failed to submit feedback: ${error.message}`);
            }
        }
        
        // Toggle advanced view
        function toggleAdvanced(button) {
            const advancedSection = button.nextElementSibling;
            if (advancedSection && advancedSection.classList.contains('advanced-section')) {
                advancedSection.classList.toggle('visible');
                button.textContent = advancedSection.classList.contains('visible') ? 
                    'Hide Advanced View' : 'Show Advanced View';
            }
        }

        // Function to manually score an article
        function manualScoreArticle(articleId) {
            const inputElement = document.getElementById('manual-score-input');
            const errorMessageElement = document.querySelector('.manual-score-error-message');
            
            // Reset error message
            errorMessageElement.style.display = 'none';
            errorMessageElement.textContent = '';
            
            // Validate input
            const scoreValue = parseFloat(inputElement.value);
            if (isNaN(scoreValue) || scoreValue < -1 || scoreValue > 1) {
                errorHandler.showError(errorMessageElement, 'Please enter a valid score between -1 and 1');
                return;
            }
            
            // Disable button during request
            const btn = document.querySelector('.manual-score-btn');
            btn.disabled = true;
            
            // Send score to backend
            fetch(`/api/manual-score/${articleId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ score: scoreValue })
            })
            .then(resp => {
                if (!resp.ok) {
                    return errorHandler.parseError(resp).then(message => {
                        throw new Error(message);
                    });
                }
                return resp.json();
            })
            .then(data => {
                // Update UI with new score
                updateArticleDetails(articleId);
                
                // Clear input field
                inputElement.value = '';
                
                // Show success message using error handler utility
                errorHandler.showSuccess(errorMessageElement, 'Score updated successfully!');
                
                // Re-enable button
                btn.disabled = false;
            })
            .catch(err => {
                errorHandler.showError(errorMessageElement, `Error: ${err.message}`);
                btn.disabled = false;
            });
        }

        // Helper functions for LLM rescoring
        function setupRescoreUI(elements) {
            elements.btn.disabled = true;
            elements.btnSpinner.style.display = 'inline-block';
            elements.progressContainer.style.display = 'block';
            elements.progressBar.style.width = '0%';
            elements.progressMessages.innerHTML = '';
            elements.errorMessage.style.display = 'none';
            elements.errorMessage.textContent = '';
        }

        function handleRescoreProgress(progress, elements, articleId) {
            if (progress.status === "InProgress") {
                if (progress.percent !== undefined) {
                    elements.progressBar.style.width = `${progress.percent}%`;
                }
                
                if (progress.message && (!elements.progressMessages.lastChild || 
                    elements.progressMessages.lastChild.textContent !== progress.message)) {
                    const li = document.createElement('li');
                    li.textContent = progress.message;
                    elements.progressMessages.appendChild(li);
                }
            }
            else if (progress.status === "Success") {
                elements.progressBar.style.width = '100%';
                const li = document.createElement('li');
                li.textContent = "Scoring complete!";
                elements.progressMessages.appendChild(li);
                
                updateArticleDetails(articleId);
                loadEnsembleDetails(articleId);
                
                elements.btn.disabled = false;
                elements.btnSpinner.style.display = 'none';
                return true;
            } 
            else if (progress.status === "Error") {
                elements.errorMessage.textContent = "Error: " + (progress.error || "Unknown error occurred");
                elements.errorMessage.style.display = 'block';
                elements.progressBar.style.backgroundColor = 'red';
                elements.btn.disabled = false;
                elements.btnSpinner.style.display = 'none';
                return true;
            }
            return false;
        }

        // Function to start LLM rescoring an article
        function llmRescoreArticle(articleId) {
            const progressSection = document.querySelector('.score-article-section');
            const elements = {
                progressBar: progressSection.querySelector('.score-progress-bar'),
                progressContainer: progressSection.querySelector('.llm-rescore-progress-container'),
                progressMessages: progressSection.querySelector('.score-progress-messages'),
                errorMessage: progressSection.querySelector('.llm-rescore-error-message'),
                btn: document.querySelector('.llm-rescore-btn'),
                btnSpinner: document.querySelector('.llm-rescore-btn .llm-rescore-spinner')
            };
    
            setupRescoreUI(elements);
    
            fetch(`/api/llm/reanalyze/${articleId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: '{}'
            })
            .then(resp => {
                if (!resp.ok) {
                    return errorHandler.parseError(resp).then(message => {
                        throw new Error(message);
                    });
                }
                return resp.json();
            })
            .then(() => {
                const evtSource = new EventSource(`/api/llm/score-progress/${articleId}`);
                
                evtSource.onmessage = (event) => {
                    try {
                        const progress = JSON.parse(event.data);
                        if (handleRescoreProgress(progress, elements, articleId)) {
                            evtSource.close();
                        }
                    } catch (e) {
                        console.error("Error parsing SSE message:", e);
                    }
                };
                
                evtSource.onerror = () => {
                    errorHandler.showError(elements.errorMessage, "Connection lost. Please try again.");
                    elements.btn.disabled = false;
                    elements.btnSpinner.style.display = 'none';
                    evtSource.close();
                };
            })
            .catch(err => {
                errorHandler.showError(elements.errorMessage, "Failed to start scoring: " + err.message);
                elements.btn.disabled = false;
                elements.btnSpinner.style.display = 'none';
            });
        }

        // Set bias slider positions on load
        document.addEventListener('DOMContentLoaded', function() {
            const slider = document.querySelector('.bias-slider');
            if (slider) {
                // Correctly position model indicators via JavaScript instead of in-line style
                const indicators = slider.querySelectorAll('.model-indicator');
                indicators.forEach(function(indicator) {
                    const position = indicator.getAttribute('data-model-position');
                    if (position) {
                        indicator.style.left = `${position}%`;
                    }
                });
                
                // Position the composite indicator if needed
                const compositeIndicator = slider.querySelector('.composite-indicator');
                if (compositeIndicator) {
                    const position = compositeIndicator.getAttribute('data-slider-position');
                    if (position) {
                        compositeIndicator.style.left = `${position}%`;
                    }
                }
            }
        });

        // Load ensemble details on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Extract article ID from URL
            const pathParts = window.location.pathname.split('/');
            const articleId = pathParts[pathParts.length - 1];
            
            if (articleId && !isNaN(Number(articleId))) {
                loadEnsembleDetails(articleId);
                // Also update the "Back to Articles" link to point to the correct endpoint
                const backLink = document.querySelector('header a.primary-button');
                if (backLink) {
                    backLink.href = "/";
                }
            }
        });
    </script>
</body>
</html>
